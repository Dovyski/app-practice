<template>
  <div data-name="services">
    <div class="block">
      <div class="row">
        <div class="col-50">
          <img src="../static/images/work.png" style="width: 100%; height: auto;" />
        </div>
        <div class="col-50">
          <p class="text-color-gray text-align-justify no-margin">Conheça os serviços que o PRACTICE oferece!</p>
          <a href="/services/service-request/" class="button button-raised button-fill margin-top-half">Solicitar serviço</a>
        </div>
      </div>
    </div>

    <!-- Active services -->
    <div class="block-title">
      <h3 class="no-margin margin-bottom-half"><i class="f7-icons">timer</i> Serviços solicitados</h3>
    </div>

    <div class="card">
      <div class="list media-list no-margin">
        <ul>
          {{#if activeServices}}
            {{#unless activeServices.length}}
              <li class="item-content">
                <div class="item-inner">
                  <div class="item-title">Nada para mostrar aqui...</div>
                  <div class="item-text no-wrap">
                    <a href="/services/service-request/">Clique aqui para solicitar um serviço!</a>
                  </div>
                </div>
              </li>
            {{else}}
              {{#each activeServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
              {{/each}}
            {{/unless}}
          {{else}}
            {{#each '123'}}
              <li>
                <a class="item-link item-content skeleton-text skeleton-effect-blink">
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">____________</div>
                      <div class="item-after">_____</div>
                    </div>
                    <div class="item-text no-wrap">____________________________________</div>
                  </div>
                </a>
            </li>
            {{/each}}
          {{/if}}
        </ul>
      </div>
    </div>

    <!-- Done services -->
    
    {{#if doneServices}}
      {{#unless doneServices.length}} {{else}}
        <div class="block-title">
          <h3 class="no-margin margin-bottom-half"><i class="f7-icons">checkmark_circle</i> Serviços concluídos</h3>
        </div>

        <div class="card">
          <div class="list media-list no-margin">
            <ul>
              {{#each doneServices}}
                <li>
                  <a href="/services/{{this.id}}/" class="item-link item-content">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">{{this.title}}</div>
                        <div class="item-after">{{this.created_at}}</div>
                      </div>
                      <div class="item-text no-wrap">{{this.description}}</div>
                    </div>
                  </a>
                </li>
              {{/each}}
            </ul>
          </div>
        </div>
      {{/unless}}
    {{/if}}

  </div>
</template>
<script>
  export default {
    data: function () {
      return {
        activeServices: null,
        doneServices: null,
      }
    },
    methods: {
      processDate: function (date) {
        date = new Date(date)
        const now = new Date()
        let difference = now - date
        // Years
        const years = Math.floor(difference / (1000*60*60*24*30*12))
        if (years > 0)
          if (years == 1)
            return years + ' ano'
          else
            return years + ' anos'
        // Months
        const months = Math.floor(difference / (1000*60*60*24*30))
        if (months > 0)
          if (months == 1)
            return months + ' mês'
          else
            return months + ' meses'
        // Days
        const days = Math.floor(difference / (1000*60*60*24))
        if (days > 0)
          if (days == 1)
            return days + ' dia'
          else
            return days + ' dias'
        // Seconds
        const seconds = Math.floor(difference / (1000*60*60))
        if (seconds > 0)
          if (seconds == 1)
            return seconds + ' segundo'
          else
            return seconds + ' segundos'
        return date.toUpperCase().charAt(0).toUpperCase() + date.slice(1)
      },
      loadServices: function () {
        var self = this
        var app = self.$app

        app.storage.getRequestedServices(function (services) {
          if (services) {
            services = services.data
            let activeServices = []
            let doneServices = []
            // Processing data
            for (let i=0; i<services.length; i++) {
              services[i].created_at = self.processDate(services[i].created_at)
              if (services[i].status === 3) 
                doneServices.push(services[i])
              else
                activeServices.push(services[i])
            }
            // Updating state
            self.$setState({
              doneServices: doneServices,
              activeServices: activeServices,
            })
          }
        })
      },
    },
    on: {
      tabInit: function(e, page) {
        this.loadServices()
      }
    }
  }
</script>